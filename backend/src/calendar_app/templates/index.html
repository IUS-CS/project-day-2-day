{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- Notifications Banner (if any urgent) -->
{% if notification_counts.overdue > 0 or notification_counts.due_today > 0 %}
<div style="background:#fff3cd; border:1px solid #ffc107; padding:12px; border-radius:6px; margin-bottom:20px;">
    <strong>‚ö†Ô∏è You have urgent tasks!</strong>
    {% if notification_counts.overdue > 0 %}
        <span style="color:#dc3545;">{{ notification_counts.overdue }} overdue</span>
    {% endif %}
    {% if notification_counts.due_today > 0 %}
        <span style="color:#ffc107;">{{ notification_counts.due_today }} due today</span>
    {% endif %}
</div>
{% endif %}

<div style="display:flex; gap:20px;">

    <!-- Assignments Card -->
    <div style="background:white; padding:20px; border:1px solid #ddd; width:33%; border-radius:6px;">
        <h3>Upcoming Assignments</h3>
        <hr>

        {% for task in tasks %}
        <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:4px;">
            <p style="margin:0;"><strong>{{ task.name }}</strong><br>
            Due: {{ task.due_date.strftime('%b %d') }}<br>
            Status: {{ task.status }}<br>
            <a href="/?task_id={{ task.id }}" style="font-size:12px; color:#007bff;">
                View Notes ({{ notes|selectattr('task_id', 'equalto', task.id)|list|length }})
            </a>
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- Notes Card -->
    <div style="background:white; padding:20px; border:1px solid #ddd; width:33%; border-radius:6px;">
        <h3>Notes</h3>

        <!-- Search and Filter Bar -->
        <div style="margin-bottom:15px;">
            <form method="GET" style="display:flex; gap:5px;">
                <input type="text"
                       name="search"
                       placeholder="Search notes..."
                       value="{{ search_query }}"
                       style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                <button type="submit"
                        style="padding:6px 12px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px;">
                    Search
                </button>
            </form>

            {% if current_filter or search_query %}
                <a href="/" style="font-size:12px; color:#007bff; margin-top:5px; display:inline-block;">Clear filters</a>
            {% endif %}
        </div>

        <hr>

        {% if notes %}
            {% for note in notes %}
                <div style="margin-bottom:12px; padding:8px; background:#f8f9fa; border-radius:4px;" id="note-{{ note.id }}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <p style="margin:0; font-size:14px;" class="note-content-{{ note.id }}">‚Ä¢ {{ note.content }}</p>
                            <small style="color:#6c757d;">Task #{{ note.task_id }}</small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="toggleEdit({{ note.id }})"
                                    style="color:#007bff; background:none; border:none; cursor:pointer; font-size:12px; padding:2px;">
                                ‚úé
                            </button>
                            <a href="/delete-note/{{ note.id }}"
                               style="color:red; text-decoration:none; font-size:12px;">
                                ‚úï
                            </a>
                        </div>
                    </div>

                    <!-- Hidden edit form -->
                    <form method="POST" action="/edit-note/{{ note.id }}"
                          style="display:none; margin-top:8px;"
                          class="edit-form-{{ note.id }}">
                        <input type="text"
                               name="content"
                               value="{{ note.content }}"
                               style="width:80%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;"
                               required>
                        <button type="submit"
                                style="padding:6px 10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">
                            Save
                        </button>
                        <button type="button"
                                onclick="toggleEdit({{ note.id }})"
                                style="padding:6px 10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">
                            Cancel
                        </button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <p style="color:#888;">No notes found.</p>
        {% endif %}

        <!-- Add Note Form -->
        <form method="POST" action="/add-note" style="margin-top:15px;">
            <select name="task_id" style="padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:8px; font-size:13px;">
                {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.name }}</option>
                {% endfor %}
            </select>
            <div style="display:flex; gap:5px;">
                <input type="text"
                       name="content"
                       placeholder="Add a new note..."
                       style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"
                       required>
                <button type="submit"
                        style="padding:8px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">
                    Add
                </button>
            </div>
        </form>
    </div>

    <!-- Notifications Card -->
    <div style="background:white; padding:20px; border:1px solid #ddd; width:33%; border-radius:6px;">
        <h3>Notifications</h3>
        <hr>

        {% if notifications %}
            {% for notification in notifications %}
                <div style="padding:10px; margin-bottom:10px; background:#f8f9fa; border-left:4px solid {{ notification.color }}; border-radius:4px;">
                    <p style="margin:0; font-size:14px;">
                        <span style="font-size:16px;">{{ notification.icon }}</span>
                        {{ notification.message }}
                    </p>
                    <small style="color:#6c757d;">{{ notification.task.due_date.strftime('%b %d, %Y') }}</small>
                </div>
            {% endfor %}
        {% else %}
            <p style="color:#888;">üéâ No urgent notifications!</p>
        {% endif %}

        <!-- Notification Summary -->
        <div style="margin-top:15px; padding:10px; background:#e7f3ff; border-radius:4px; font-size:13px;">
            <strong>Summary:</strong><br>
            üî¥ {{ notification_counts.overdue }} Overdue<br>
            ‚ö†Ô∏è {{ notification_counts.due_today }} Due Today<br>
            üîî {{ notification_counts.due_soon }} Due Soon
        </div>
    </div>

</div>

<script>
function toggleEdit(noteId) {
    const content = document.querySelector('.note-content-' + noteId);
    const form = document.querySelector('.edit-form-' + noteId);

    if (form.style.display === 'none') {
        content.style.display = 'none';
        form.style.display = 'block';
    } else {
        content.style.display = 'block';
        form.style.display = 'none';
    }
}
</script>

{% endblock %}